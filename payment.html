<!DOCTYPE html>
<html lang="ko">
    <head> </head>

<body>
    <!-- jQuery -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js" ></script>
    <!-- iamport.payment.js -->
    <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>

    <div>
        <h2>IAMPORT 결제 데모</h2>
        <li>
            <button onclick="requestPay()" type="botton">결제테스트</button>
            <button onclick="unschedule()" type="button">구독취소 </button>
        </li>
    </div>
    <script>
      await axios({
        url: `https://api.iamport.kr/subscribe/payments/schedule`,
        method: "post",
        headers: { "Authorization": access_token }, // 인증 토큰 Authorization header에 추가
        data: {
          customer_uid: "1_1", // 카드(빌링키)와 1:1로 대응하는 값
          schedules: [
            {
              merchant_uid: (date.getTime()/1000)+60, // 주문 번호
              schedule_at: (date.getTime()/1000)+60, // 결제 시도 시각 in Unix Time Stamp. 예: 다음 달 1일
              amount: 200,
              name: "월간 이용권 정기결제",
            //   buyer_name: "홍길동",
            //   buyer_tel: "01012345678",
            //   buyer_email: "gildong@gmail.com"
            }
          ]
        }
      });
        function requestPay() {
        // var IMP = window.IMP; // 생략 가능
        IMP.init("imp62201906"); // 예: imp00000000 가맹점 식별코드
        // IMP.request_pay(param, callback) 결제창 호출
        IMP.request_pay({ // param
            pg: "danal_tpay",
            pay_method: "card",
            merchant_uid: "1_month_pay_32333", //주문번호
            name: "첫달무료인증결제\n(1개월 정기 구독권)", // 상품명
            customer_uid:"1_1",
            amount: 0, //금액
            // buyer_email: "", //구매자 정보
            // buyer_name: "홍길동",
            // buyer_tel: "010-4242-4242",
            // buyer_addr: "서울특별시 강남구 신사동",
            // buyer_postcode: "01181"
        }, function (rsp) { // callback
            if (rsp.success) {
                jQuery.ajax({
                    url: "http://34.64.207.117:3000/billings",
                    method: "POST",
                    headers: {"Content_Type": "application/json"},
                    data: {
                        costomer_uid: "1_1" // 카드 호칭 (타인카드, 개인카드 모두 중복금지)
                    }
                })
            // 결제 성공 시 로직,
        } else {
            // 결제 실패 시 로직,
            alert("빌링키 발급 실패 : 코드(" + rsp.error_code+") / 메시지(" + rsp.error_msg + ")");
        }
        });
        }
    </script>
</body>
</html>